<!-- frontend/public/poster-callback.html -->
<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Poster Authorization</title>
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  margin: 0;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
.container {
  background: white;
  padding: 2rem;
  border-radius: 12px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  text-align: center;
  max-width: 400px;
}
.spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #667eea;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: 0 auto 1rem;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.success {
  color: #10b981;
  font-size: 3rem;
}
.error {
  color: #ef4444;
  font-size: 3rem;
}
h2 {
  color: #1f2937;
  margin: 1rem 0;
}
p {
  color: #6b7280;
  margin: 0.5rem 0;
}
</style>
</head>
<body>
<div class="container">
  <div class="spinner" id="spinner"></div>
  <div id="icon" style="display: none;"></div>
  <h2 id="title">Обробка авторизації...</h2>
  <p id="message">Будь ласка, зачекайте</p>
</div>

<script>
console.log('Callback page loaded');
console.log('Window opener exists:', !!window.opener);

// Отримуємо параметри з URL
const urlParams = new URLSearchParams(window.location.search);
const code = urlParams.get('code');
const account = urlParams.get('account');
const error = urlParams.get('error');

console.log('Received params:', { code, account, error });

const spinner = document.getElementById('spinner');
const icon = document.getElementById('icon');
const title = document.getElementById('title');
const message = document.getElementById('message');

function showSuccess() {
  spinner.style.display = 'none';
  icon.style.display = 'block';
  icon.className = 'success';
  icon.textContent = '✅';
  title.textContent = 'Успішно підключено!';
  message.textContent = 'Вікно закриється автоматично';
}

function showError(errorText) {
  spinner.style.display = 'none';
  icon.style.display = 'block';
  icon.className = 'error';
  icon.textContent = '❌';
  title.textContent = 'Помилка авторизації';
  message.textContent = errorText || 'Спробуйте ще раз';
}

function saveToLocalStorage(key, data) {
  try {
    localStorage.setItem(key, JSON.stringify(data));
    console.log('Data saved to localStorage:', key);
    return true;
  } catch (e) {
    console.error('localStorage error:', e);
    return false;
  }
}

function sendViaPostMessage(messageData) {
  console.log('Attempting to send via postMessage:', messageData);
  
  if (!window.opener) {
    console.error('No window.opener available');
    return false;
  }

  try {
    window.opener.postMessage(messageData, '*');
    console.log('Message sent via postMessage');
    return true;
  } catch (e) {
    console.error('postMessage error:', e);
    return false;
  }
}

// Даем время родительскому окну установить обработчик
setTimeout(() => {
  // Обробка результату
  if (error) {
    console.log('Processing error:', error);
    showError(error);
    
    const errorData = {
      type: 'POSTER_AUTH_ERROR',
      error: error,
      timestamp: Date.now()
    };
    
    // Пытаемся отправить двумя способами
    saveToLocalStorage('poster_auth_result', errorData);
    sendViaPostMessage(errorData);
    
    setTimeout(() => {
      window.close();
    }, 3000);
    
  } else if (code && account) {
    console.log('Processing success with code and account');
    showSuccess();
    
    const successData = {
      type: 'POSTER_AUTH_SUCCESS',
      code: code,
      account: account,
      name: account,
      timestamp: Date.now()
    };
    
    // Сохраняем в localStorage
    const savedToStorage = saveToLocalStorage('poster_auth_result', successData);
    
    // Пытаемся также отправить через postMessage
    const sentViaPost = sendViaPostMessage(successData);
    
    if (savedToStorage || sentViaPost) {
      message.textContent = 'Дані збережено. Вікно закриється автоматично';
      setTimeout(() => {
        window.close();
      }, 1500);
    } else {
      message.textContent = 'Помилка збереження даних. Закрийте це вікно вручну.';
    }
    
  } else {
    console.log('Missing parameters');
    showError('Невірні параметри авторизації');
    
    const errorData = {
      type: 'POSTER_AUTH_ERROR',
      error: 'Невірні параметри',
      timestamp: Date.now()
    };
    
    saveToLocalStorage('poster_auth_result', errorData);
    sendViaPostMessage(errorData);
    
    setTimeout(() => {
      window.close();
    }, 3000);
  }
}, 500);
</script>
</body>
</html>